<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Doctor Appointment History</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
    <script src="/js/auth.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: #f9fafb;
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 250px;
            background-color: #ffffff;
            border-right: 1px solid #e5e7eb;
            padding: 30px 20px;
            position: relative;
        }

        .sidebar h1 {
            font-size: 22px;
            color: #1d4ed8;
            margin-bottom: 40px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            font-size: 16px;
            color: #374151;
            cursor: pointer;
            text-decoration: none;
        }

        .nav-item:hover {
            color: #1d4ed8;
        }

        .profile-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 10px;
            border-radius: 8px;
            background-color: #f3f4f6;
        }

        .user-profile {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: inherit;
        }

        .user-profile img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #4f46e5;
            margin-right: 10px;
        }

        .user-profile span {
            font-size: 14px;
            color: #374151;
        }

        .logout-btn {
            background: #FFFF;
            border: none;
            font-size: 15px;
            color: #686363;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .logout-btn:hover {
            transform: scale(1.2);
        }

        .main-content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }

        .page-title {
            font-size: 26px;
            margin-bottom: 20px;
            color: #111827;
        }

        .subheading {
            color: #6b7280;
            margin-bottom: 20px;
        }

        .search-filter {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .search-filter input {
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            width: 300px;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
        }

        .tab-buttons button {
            padding: 10px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
            cursor: pointer;
        }

        .tab-buttons button.active {
            background: #2563eb;
            color: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f3f4f6;
        }

        th, td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .status {
            padding: 6px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .status.confirmed {
            background: #e0f2fe;
            color: #0284c7;
        }

        .status.completed {
            background: #dcfce7;
            color: #16a34a;
        }

        .doctor-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .doctor-img {
            width: 40px;
            height: 40px;
            border-radius: 9999px;
            object-fit: cover;
        }

        #pagination2 {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 8px;
        }

        .pagination-btn {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 8px;
            cursor: pointer;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #f3f4f6;
        }

        .pagination-btn.active {
            background: #2563eb;
            color: white;
            font-weight: bold;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .search-filter {
                flex-direction: column;
            }

            .search-filter input {
                width: 100%;
            }

            table, thead, tbody, th, td, tr {
                display: block;
            }

            thead {
                display: none;
            }

            tr {
                margin-bottom: 16px;
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                padding: 12px;
                background: white;
            }

            td {
                padding: 6px 0;
                display: flex;
                justify-content: space-between;
                font-size: 14px;
            }

            td::before {
                content: attr(data-label);
                font-weight: 600;
                color: #4b5563;
            }

            .doctor-info {
                flex-direction: column;
                align-items: flex-start;
            }

            .doctor-img {
                margin-bottom: 6px;
            }
        }
    </style>
</head>
<body onload="fetchHistoryData()">

<div class="sidebar">
    <h1>ALPHAHEALTH</h1>
    <a href="/home.html" class="nav-item">üè† Home</a>
    <a class="nav-item" href="/doctor/appointment.html">ü©∫ Doctor Appointment</a>
    <a class="nav-item" href="/lab/test.html">üß™ Lab Test Appointment</a>
    <a class="nav-item" href="/notifications.html">üîî Notifications</a>
    <a class="nav-item" href="/history/history.html">üìú History</a>

    <!-- Profile and Logout -->
    <div class="profile-container">
        <a href="/profile.html" class="user-profile" title="Go to My Profile">
            <img src="/images/logo.jpg" alt="Profile">
            <span id="first-name"></span>
        </a>
        <button class="logout-btn" onclick="logout()" title="Logout">[-></button>
    </div>
</div>


<div class="main-content">
    <h2>History</h2>
    <div class="subheading">Your all doctor appointment and lab test history</div>

    <div class="search-filter">
        <input type="text" placeholder="üîç Search by name" id="searchInput" oninput="renderAppointmentsHistory()" />
        <div class="tab-buttons">
            <button class="active">Doctor Appointment</button>
            <button>Lab Test Appointment</button>
        </div>
    </div>

    <table>
        <thead>
        <tr>
            <th>Appointment ID</th>
            <th id="bookingDateLabel">Booking Date</th>
            <th id="appointmentDateLabel">Appointment Date</th>
            <th>Status</th>
            <th id="column-label">Doctor</th>
        </tr>
        </thead>
        <tbody id="doctor-history-table-body"></tbody>
    </table>

    <div id="pagination2"></div>
</div>

<script>
    let currentHistoryPage = 1;
    const historyItemsPerPage = 5;
    let activeTab = 'doctor';
    let doctorData = [];
    let labData = [];

    async function fetchHistoryData() {
        try {
            const token = localStorage.getItem('jwt');
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };

            const [doctorRes, labRes] = await Promise.all([
                fetch('/api/doctor/booking/fetch/all/history', { headers }),
                fetch('/api/booking/lab/test/fetch/all/history', { headers })
            ]);

            const profileIconName = document.getElementById("first-name").innerHTML =
                `${parseJwt(token).userName}`;

            const doctorResJson = await doctorRes.json();
            const labResJson = await labRes.json();

            doctorData = doctorResJson.doctorBookingHistories || [];
            labData = labResJson.labTestsBook || [];

            Toastify({
                text: "History data fetched successfully!",
                duration: 3000,
                close: true,
                gravity: "top",
                position: "right",
                backgroundColor: "#16a34a",
                stopOnFocus: true,
            }).showToast();
            renderAppointmentsHistory();
        } catch (error) {
            Toastify({
                text: "Error fetching history data.",
                duration: 3000,
                close: true,
                gravity: "top",
                position: "right",
                backgroundColor: "#dc2626",
                stopOnFocus: true,
            }).showToast();
            setTimeout(() => {
                window.location.href = '/history/history.html';
            }, 1000);

            console.error('Error fetching data:', error);
        }
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function renderAppointmentsHistory() {
        const data = activeTab === 'doctor' ? doctorData : labData;
        const searchTerm = document.getElementById("searchInput").value.toLowerCase();
        const columnLabel = document.getElementById("column-label");
        const bookingDateLabel = document.getElementById("bookingDateLabel");
        const appointmentDateLabel = document.getElementById("appointmentDateLabel");

        columnLabel.textContent = activeTab === 'doctor' ? 'Doctor' : 'Lab';

        // Dynamically change column labels based on active tab
        if (activeTab === 'doctor') {
            bookingDateLabel.textContent = 'Booking Date';
            appointmentDateLabel.textContent = 'Appointment Date';
        } else {
            bookingDateLabel.textContent = 'Order Date';
            appointmentDateLabel.textContent = 'Deliver Date';
        }

        const filteredData = data.filter(item => {
            const name = (item.doctorName || item.labTestName || "").toLowerCase();
            return name.includes(searchTerm);
        });

        const startIndex = (currentHistoryPage - 1) * historyItemsPerPage;
        const endIndex = startIndex + historyItemsPerPage;
        const paginated = filteredData.slice(startIndex, endIndex);
        const tbody = document.getElementById("doctor-history-table-body");
        tbody.innerHTML = "";

        paginated.forEach(app => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td data-label="Appointment ID">#${app.id || app.doctorBookingId}</td>
                <td data-label="Booking Date/Order Date">${formatDate(app.oderDate || app.bookingDate)}</td>
                <td data-label="Appointment/Deliver Date">${formatDate(app.deliveryDate || app.appointmentDate)}</td>
                <td data-label="Status"><span class="status ${app.status}">${app.status}</span></td>
                <td data-label="${activeTab === 'doctor' ? 'Doctor' : 'Lab'}">
                    <div class="doctor-info">
                        <img src="${app.doctorImageUrl || app.labTestImageUrl}" class="doctor-img"/>
                        <div>
                            <div class="doctor-name">${app.doctorName || app.labTestName}</div>
                            <div class="doctor-specialty" style="font-size: 14px; color: #6b7280;">
                                ${app.designation || "Lab Test"}
                            </div>
                        </div>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });

        renderPaginationTwo(filteredData.length);
    }

    function renderPaginationTwo(totalItems) {
        const totalPages = Math.ceil(totalItems / historyItemsPerPage);
        const paginationDiv = document.getElementById("pagination2");
        paginationDiv.innerHTML = "";

        const createBtn = (text, page, disabled = false, active = false) => {
            const btn = document.createElement("button");
            btn.className = "pagination-btn";
            if (active) btn.classList.add("active");
            btn.textContent = text;
            btn.disabled = disabled;
            btn.onclick = () => {
                currentHistoryPage = page;
                renderAppointmentsHistory();
            };
            return btn;
        };

        paginationDiv.appendChild(createBtn("<", currentHistoryPage - 1, currentHistoryPage === 1));

        const maxPages = 5;
        let start = Math.max(1, currentHistoryPage - 2);
        let end = Math.min(totalPages, start + maxPages - 1);

        for (let i = start; i <= end; i++) {
            paginationDiv.appendChild(createBtn(i, i, false, i === currentHistoryPage));
        }

        paginationDiv.appendChild(createBtn(">", currentHistoryPage + 1, currentHistoryPage === totalPages));
    }

    document.querySelectorAll(".tab-buttons button").forEach(btn => {
        btn.addEventListener("click", () => {
            document.querySelectorAll(".tab-buttons button").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            activeTab = btn.textContent.includes("Doctor") ? 'doctor' : 'lab';
            currentHistoryPage = 1;
            renderAppointmentsHistory();
        });
    });
</script>
</body>
</html>
